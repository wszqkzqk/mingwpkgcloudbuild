From 1a700e863b008a5bf5dabca005b14be5c1163b76 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E6=98=9F=E5=A4=96=E4=B9=8B=E7=A5=9E?= <wszqkzqk@qq.com>
Date: Mon, 24 Oct 2022 23:26:55 +0800
Subject: [PATCH] Support the underscore separates digits in numbers

---
 vala/valascanner.vala | 60 +++++++++++++++++++++++++++++++++++++------
 1 file changed, 52 insertions(+), 8 deletions(-)

diff --git a/vala/valascanner.vala b/vala/valascanner.vala
index daeb97feb..32cd37fe3 100644
--- a/vala/valascanner.vala
+++ b/vala/valascanner.vala
@@ -606,13 +606,35 @@ public class Vala.Scanner {
 		    && current[1] == 'x' && current[2].isxdigit ()) {
 			// hexadecimal integer literal
 			current += 2;
-			while (current < end && current[0].isxdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isxdigit ()) {
+					current += 1;
+				} else if (current[0] == '_') {
+					// Support the underscore symbol separates digits in number values
+					current += 1;
+					if ((current >= end) || (!(current[0].isxdigit ()))) {
+						current -= 1;
+						break;
+					}
+				} else {
+					break;
+				}
 			}
 		} else {
 			// decimal number
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isxdigit ()) {
+					current += 1;
+				} else if (current[0] == '_') {
+					// Support the underscore symbol separates digits in number values
+					current += 1;
+					if ((current >= end) || (!(current[0].isxdigit ()))) {
+						current -= 1;
+						break;
+					}
+				} else {
+					break;
+				}
 			}
 		}
 
@@ -620,8 +642,19 @@ public class Vala.Scanner {
 		if (current < end - 1 && current[0] == '.' && current[1].isdigit ()) {
 			type = TokenType.REAL_LITERAL;
 			current++;
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isxdigit ()) {
+					current += 1;
+				} else if (current[0] == '_') {
+					// Support the underscore symbol separates digits in number values
+					current += 1;
+					if ((current >= end) || (!(current[0].isxdigit ()))) {
+						current -= 1;
+						break;
+					}
+				} else {
+					break;
+				}
 			}
 		}
 
@@ -632,8 +665,19 @@ public class Vala.Scanner {
 			if (current < end && (current[0] == '+' || current[0] == '-')) {
 				current++;
 			}
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isxdigit ()) {
+					current += 1;
+				} else if (current[0] == '_') {
+					// Support the underscore symbol separates digits in number values
+					current += 1;
+					if ((current >= end) || (!(current[0].isxdigit ()))) {
+						current -= 1;
+						break;
+					}
+				} else {
+					break;
+				}
 			}
 		}
 
-- 
2.38.1.windows.1

